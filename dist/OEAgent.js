"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const child_process_1=require("child_process"),protractor_1=require("protractor"),OEButtons_enum_1=require("./OEButtons.enum"),OEElement_1=require("./OEElement"),OESocket_1=require("./OESocket"),OEUtils_1=require("./OEUtils");class OEAgent{constructor(e=new OESocket_1.OESocket){this.oeSocket=e}start(e){return protractor_1.browser.call(()=>{const r=this.buildCommandLine(e),t=`${__dirname.replace(/\\/g,"/")}/abl/`;OEUtils_1.OEUtils.consoleLogMessage(`Executing OpenEdge with command line: ${r}`,OEUtils_1.MessageType.INFO),OEUtils_1.OEUtils.consoleLogMessage(`Current working directory: ${t}`,OEUtils_1.MessageType.INFO);const o=child_process_1.exec(r,{cwd:t}),n=new Promise(e=>setTimeout(()=>e({status:!0}),5e3)),s=new Promise(e=>o.on("error",r=>e({status:!1,error:r})));return Promise.race([n,s]).then(r=>r.status?this.connect(e.host,e.port):Promise.reject(r.error))})}connect(e,r){return protractor_1.browser.call(()=>this.oeSocket.connect(e,r))}connected(){return this.oeSocket.connected()}waitForWindow(e,r=1e4){const t=new OEElement_1.OEElement(this);return protractor_1.browser.wait(()=>this.oeSocket.send(!0,"FINDWINDOW",e).then(e=>t.id=parseInt(e)),r),t}findWindow(e){const r=new OEElement_1.OEElement(this);return protractor_1.browser.call(()=>this.oeSocket.send(!0,"FINDWINDOW",e).then(e=>r.id=parseInt(e))),r}waitForElement(e,r=!0,t=1e4,o){const n=new OEElement_1.OEElement(this),s=o?o.id:"";return protractor_1.browser.wait(()=>this.oeSocket.send(!0,"FINDELEMENT",e,r,s).then(e=>n.id=parseInt(e)).catch(()=>protractor_1.browser.sleep(2e3)),t),n}findElement(e,r=!0,t){const o=new OEElement_1.OEElement(this),n=t?t.id:"";return protractor_1.browser.call(()=>this.oeSocket.send(!0,"FINDELEMENT",e,r,n).then(e=>o.id=parseInt(e))),o}findElementByAttribute(e,r,t=!0,o){const n=new OEElement_1.OEElement(this),s=o?o.id:"";return protractor_1.browser.call(()=>this.oeSocket.send(!0,"FINDELEMENTBYATTRIBUTE",e,r,t,s).then(e=>n.id=parseInt(e))),n}clear(e){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"CLEAR",e.id).then(()=>!0))}sendKeys(e,r){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"SENDKEYS",r.id,e).then(()=>!0))}check(e,r){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"CHECK",r.id,e).then(()=>!0))}select(e,r=!1,t){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"SELECT",t.id,e,r).then(()=>!0))}selectRow(e,r){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"SELECTROW",r.id,e).then(()=>!0))}repositionToRow(e,r){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"REPOSITIONTOROW",r.id,e).then(()=>!0))}choose(e){return protractor_1.browser.call(()=>this.oeSocket.send(!1,"CHOOSE",e.id).then(()=>protractor_1.browser.sleep(500)).then(()=>!0))}apply(e,r){return protractor_1.browser.call(()=>this.oeSocket.send(!1,"APPLY",r.id,e).then(()=>protractor_1.browser.sleep(500)).then(()=>!0))}get(e,r){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"GET",r.id,e))}set(e,r,t){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"SET",t.id,e,r).then(()=>!0))}query(e,r){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"QUERY",e,r).then(e=>JSON.parse(e)))}create(e,r){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"CREATE",e,JSON.stringify(r)).then(()=>!0))}update(e,r,t){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"UPDATE",e,JSON.stringify(r),JSON.stringify(t)).then(()=>!0))}delete(e,r,t){return protractor_1.browser.call(()=>this.oeSocket.send(!0,"DELETE",e,JSON.stringify(r),JSON.stringify(t)).then(()=>!0))}run(e,r=[]){return protractor_1.browser.call(()=>this.oeSocket.send(!1,"RUN",e,r).then(()=>protractor_1.browser.sleep(500))).then(()=>!0)}quit(){return protractor_1.browser.call(()=>this.oeSocket.send(!1,"QUIT").then(()=>protractor_1.browser.sleep(500))).then(()=>!0)}windowExists(e,r=1e4){return protractor_1.browser.call(()=>new Promise(t=>{let o=!0;try{child_process_1.execSync(`${__dirname.replace(/\\/g,"/")}/robot/Robot.exe -t ${r} -w "${e}"`)}catch(e){o=!1}t(o)}))}windowSendKeys(e,r,t=1e4){return protractor_1.browser.call(()=>new Promise((o,n)=>{r=(r=Array.isArray(r)?r:[r]).join("");try{child_process_1.execSync(`${__dirname.replace(/\\/g,"/")}/robot/Robot.exe -t ${t} -w "${e}" -k ${r}`),o(!0)}catch(e){n(e)}}))}alertErrorOK(){return this.alertClick("Error",OEButtons_enum_1.OEButtons.OK)}alertWarningOK(){return this.alertClick("Warning",OEButtons_enum_1.OEButtons.OK)}alertInfoOK(){return this.alertClick("Information",OEButtons_enum_1.OEButtons.OK)}alertQuestionYes(){return this.alertClick("Question",OEButtons_enum_1.OEButtons.YES)}alertQuestionNo(){return this.alertClick("Question",OEButtons_enum_1.OEButtons.NO)}alertClick(e,r,t=1e4){return protractor_1.browser.call(()=>new Promise((o,n)=>{try{child_process_1.execSync(`${__dirname.replace(/\\/g,"/")}/robot/Robot.exe -t ${t} -w "${e}" -b ${r}`),o(!0)}catch(e){n(e)}}))}buildCommandLine(e){let r="",t="";return r+=`${e.host},`,r+=`${e.port},`,r+=`${e.outDir},`,r+=`${(e.propath||[]).join("|")},`,r+=`${e.startupFile},`,r+=`${(e.startupFileParams||[]).join("|")},`,r+=`${e.inputCodepage||"UTF-8"}`,t+=`"${e.dlcHome}/bin/prowin32.exe"`,t+=` -p "${__dirname.replace(/\\/g,"/")}/abl/OEStart.p"`,t+=` -param "${r}"`,e.parameterFile&&(t+=` -pf "${e.parameterFile}"`),e.iniFile&&(t+=` -basekey ini -ininame "${e.iniFile}"`),t}}exports.OEAgent=OEAgent;