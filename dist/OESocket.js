"use strict";var __importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var s={};if(null!=e)for(var t in e)Object.hasOwnProperty.call(e,t)&&(s[t]=e[t]);return s.default=e,s};Object.defineProperty(exports,"__esModule",{value:!0});const net=__importStar(require("net")),OEUtils_1=require("./OEUtils");class OESocket{constructor(){this.isConnected=!1}connect(e,s){return new Promise((t,o)=>{OEUtils_1.OEUtils.consoleLogMessage(`Connecting on agent server at "${e}:${s}"`,OEUtils_1.MessageType.INFO);const n=()=>this.socket=net.createConnection(s,e);n(),this.socket.on("connect",()=>this.onConnect(t)),this.socket.on("close",()=>this.onClose()),this.socket.on("error",e=>this.onError(n,5,e,o))})}connected(){return this.isConnected}close(){this.socket.end()}onConnect(e){this.isConnected=!0,OEUtils_1.OEUtils.consoleLogMessage("Agent server successfuly connected",OEUtils_1.MessageType.SUCCESS),e(!0)}onClose(){this.socket.removeAllListeners(),this.socket.destroy(),this.socket=void 0,this.isConnected=!1,OEUtils_1.OEUtils.consoleLogMessage("Agent server connection closed",OEUtils_1.MessageType.WARNING)}onError(e,s,t,o){"ECONNRESET"===t.code?this.socket.end():s>0?(s--,setTimeout(e,1e3)):(OEUtils_1.OEUtils.consoleLogMessage(`Agent server connection error: ${t.message}`,OEUtils_1.MessageType.ERROR),o(t))}onData(e){let s;const t=e.split("|"),o=t[0].toUpperCase(),n=t.length>1?t[1]:"";return"OK"===o?(OEUtils_1.OEUtils.consoleLogMessage(`Data received: "${e}"`,OEUtils_1.MessageType.SUCCESS),s=Promise.resolve(n)):(OEUtils_1.OEUtils.consoleLogMessage(`Data received: "${e}"`,OEUtils_1.MessageType.ERROR),s=Promise.reject(new Error(n))),s}send(e,...s){return new Promise((t,o)=>{const n=`${e}|${s.join("|")}`;OEUtils_1.OEUtils.consoleLogMessage(`Sending data: "${n}"`,OEUtils_1.MessageType.INFO),this.socket.write(n),e?this.socket.once("data",e=>this.onData(e.toString("utf-8")).then(t).catch(o)):t("OK")})}}exports.OESocket=OESocket;